#!/usr/bin/env python3
"""
Dist Launch - Unified command line interface for cluster management
Usage (development mode):
    ./dist-launch wait              # Wait for debug mode
    ./dist-launch run <train.sh>    # Launch training on all nodes
Usage (installed):
    dist-launch wait                # Wait for debug mode
    dist-launch run <train.sh>      # Launch training on all nodes
"""
import sys
import os
import subprocess

# Get the directory where this script is located
# Support both development mode and package installation
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
SCRIPTS_DIR = os.path.join(SCRIPT_DIR, 'dist_launch', 'scripts')
if not os.path.exists(SCRIPTS_DIR):
    SCRIPTS_DIR = os.path.join(SCRIPT_DIR, 'scripts')
RUN_PY = os.path.join(SCRIPT_DIR, 'dist_launch', 'run.py')
if not os.path.exists(RUN_PY):
    RUN_PY = os.path.join(SCRIPT_DIR, 'run.py')


def cmd_wait(args):
    """Execute wait.sh"""
    wait_script = os.path.join(SCRIPTS_DIR, 'wait.sh')
    if not os.path.exists(wait_script):
        print(f'Error: {wait_script} not found')
        sys.exit(1)
    
    # Execute wait script with remaining arguments
    cmd = ['bash', wait_script] + args
    os.execvp('bash', cmd)


def cmd_run(args):
    """Execute run.py with train script"""
    if not args:
        print('Error: train script is required')
        print('Usage: ./dist-launch run <train.sh> [options] (or dist-launch run <train.sh> if installed)')
        sys.exit(1)
    
    train_script = args[0]
    remaining_args = args[1:]
    
    # Execute run.py
    cmd = ['python3', RUN_PY, train_script] + remaining_args
    os.execvp('python3', cmd)


def main():
    """Main entry point"""
    if len(sys.argv) < 2:
        print('Usage: ./dist-launch <command> [arguments] (or dist-launch <command> if installed)')
        print('Commands:')
        print('  wait                    Wait for debug mode')
        print('  run <train.sh> [opts]   Launch training on all nodes')
        sys.exit(1)
    
    command = sys.argv[1]
    args = sys.argv[2:]
    
    if command == 'wait':
        cmd_wait(args)
    elif command == 'run':
        cmd_run(args)
    else:
        print(f'Error: Unknown command: {command}')
        print('Available commands: wait, run')
        sys.exit(1)


if __name__ == '__main__':
    main()

